### ============================================================
### Players API 테스트
### ============================================================
### 통합: 플레이어 CRUD, 승인/반려, Heartbeat, 재생로그,
###       플레이리스트 할당, 파일목록(레거시), 기기등록, IP 재등록
### ============================================================

@token = PASTE_YOUR_ACCESS_TOKEN_HERE
@playerApiKey = player_7abea96eb201435daf89550b2a3ea3d5
@baseUrl = http://localhost:8000/api/v1


### ============================================================
### 1. 플레이어 CRUD
### ============================================================

### 1-1. 플레이어 목록 조회
GET {{baseUrl}}/players?page=1&limit=10
Authorization: Bearer {{token}}

### 1-2. 플레이어 목록 조회 (필터링)
GET {{baseUrl}}/players?building_seq=1&status=ONLINE&approval=APPROVED
Authorization: Bearer {{token}}

### 1-3. 플레이어 상세 조회
GET {{baseUrl}}/players/1
Authorization: Bearer {{token}}

### 1-4. 플레이어 등록
POST {{baseUrl}}/players
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "player_name": "본관 1층 로비 디스플레이",
  "player_code": "PLAYER-001",
  "player_did": "DID-12345",
  "player_mac": "AA:BB:CC:DD:EE:FF",
  "building_seq": 1,
  "space_seq": 1,
  "player_ip": "192.168.1.100",
  "player_port": 9090,
  "player_resolution": "1920x1080",
  "player_orientation": "LANDSCAPE",
  "player_description": "본관 입구 안내 디스플레이"
}

### 1-5. 플레이어 수정
PUT {{baseUrl}}/players/1
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "player_name": "본관 1층 로비 디스플레이 (수정)",
  "playlist_seq": 1,
  "player_description": "업데이트된 설명"
}

### 1-6. 플레이어 삭제
DELETE {{baseUrl}}/players/1
Authorization: Bearer {{token}}


### ============================================================
### 2. 플레이어 승인/반려
### ============================================================

### 2-1. 플레이어 승인
POST {{baseUrl}}/players/1/approve
Authorization: Bearer {{token}}
Content-Type: application/json

{}

### 2-2. 플레이어 반려
POST {{baseUrl}}/players/1/reject
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "reject_reason": "설치 위치가 부적절합니다."
}


### ============================================================
### 3. Health Check (Heartbeat)
### ============================================================

### 3-1. Health Check 전송 (플레이어 API Key 사용)
POST {{baseUrl}}/players/heartbeat
Authorization: Bearer {{playerApiKey}}
Content-Type: application/json

{
  "player_version": "1.0.0",
  "cpu_usage": 45.5,
  "memory_usage": 68.2,
  "disk_usage": 35.7,
  "display_status": "ON",
  "resolution": "1920x1080",
  "orientation": "LANDSCAPE",
  "volume": 50,
  "network_type": "ETHERNET",
  "network_speed": 100,
  "uptime": 86400,
  "storage_free": 2048,
  "os_version": "Windows 11 23H2",
  "last_download_at": "2026-02-22T10:30:00"
}

### 3-2. Health Check 로그 조회
GET {{baseUrl}}/players/1/heartbeat-logs?page=1&limit=20
Authorization: Bearer {{token}}

### 3-3. Health Check 로그 조회 (날짜 필터)
GET {{baseUrl}}/players/1/heartbeat-logs?from=2026-02-01T00:00:00Z&to=2026-02-14T23:59:59Z
Authorization: Bearer {{token}}


### ============================================================
### 4. 재생 로그 (Play Logs)
### - GET /players/:seq/play-logs — 플레이어별 재생 이력
### - GET /contents/:seq/play-stats — 콘텐츠별 재생 통계
### ============================================================

### 4-1. 재생 로그 조회 (플레이어별) - 기본
GET {{baseUrl}}/players/1/play-logs?page=1&limit=20
Authorization: Bearer {{token}}

### 4-2. 재생 로그 조회 - 날짜 범위 필터
GET {{baseUrl}}/players/1/play-logs?from=2026-02-01T00:00:00Z&to=2026-02-28T23:59:59Z
Authorization: Bearer {{token}}

### 4-3. 재생 로그 조회 - 상태 필터
GET {{baseUrl}}/players/1/play-logs?status=COMPLETED
Authorization: Bearer {{token}}

### 4-4. 재생 로그 조회 - 플레이리스트 필터
GET {{baseUrl}}/players/1/play-logs?playlist_seq=1
Authorization: Bearer {{token}}

### 4-5. 재생 로그 조회 - 콘텐츠 필터
GET {{baseUrl}}/players/1/play-logs?content_seq=1
Authorization: Bearer {{token}}

### 4-6. 재생 로그 조회 - 복합 필터
GET {{baseUrl}}/players/1/play-logs?from=2026-02-01T00:00:00Z&to=2026-02-14T23:59:59Z&status=COMPLETED&playlist_seq=1
Authorization: Bearer {{token}}

### 4-7. 재생 통계 조회 (콘텐츠별) - 기본
GET {{baseUrl}}/contents/1/play-stats
Authorization: Bearer {{token}}

### 4-8. 재생 통계 조회 - 날짜 범위
GET {{baseUrl}}/contents/1/play-stats?from=2026-02-01T00:00:00Z&to=2026-02-28T23:59:59Z
Authorization: Bearer {{token}}


### ============================================================
### 5. 플레이어 플레이리스트 할당
### - GET/POST /players/:seq/playlists
### - PUT/DELETE /players/:seq/playlists/:ppSeq
### ============================================================

### 5-1. 플레이어 플레이리스트 할당 목록 조회
GET {{baseUrl}}/players/1/playlists
Authorization: Bearer {{token}}

### 5-2. 플레이어에 플레이리스트 할당
POST {{baseUrl}}/players/1/playlists
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "playlist_seq": 1,
  "pp_priority": 10,
  "schedule_start_time": "09:00:00",
  "schedule_end_time": "18:00:00",
  "schedule_days": "1,2,3,4,5",
  "pp_status": "ACTIVE"
}

### 5-3. 플레이어 플레이리스트 할당 수정
PUT {{baseUrl}}/players/1/playlists/1
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "pp_priority": 20,
  "schedule_start_time": "08:00:00",
  "schedule_end_time": "19:00:00",
  "pp_status": "ACTIVE"
}

### 5-4. 플레이어 플레이리스트 할당 해제
DELETE {{baseUrl}}/players/1/playlists/1
Authorization: Bearer {{token}}


### ============================================================
### 6. 파일 목록 조회 (레거시 호환 - reqWatcherFileList)
### - POST /players/file-list (PlayerApiKey 인증)
### - PHP reqWatcherFileList 하위호환 응답 포맷
### ============================================================

### 6-1. 파일 목록 조회 (성공)
POST {{baseUrl}}/players/file-list
Authorization: Bearer {{playerApiKey}}
Content-Type: application/json

{
  "watcher_ver": "1.0.0",
  "player_ver": "1.0.0"
}

### 6-2. 파일 목록 조회 (버전 정보 없이)
POST {{baseUrl}}/players/file-list
Authorization: Bearer {{playerApiKey}}
Content-Type: application/json

{}

### 6-3. 파일 목록 조회 (API Key 없이 - 401 에러)
POST {{baseUrl}}/players/file-list
Content-Type: application/json

{
  "watcher_ver": "1.0.0"
}

### 6-4. 파일 목록 조회 (잘못된 API Key - 401 에러)
POST {{baseUrl}}/players/file-list
Authorization: Bearer invalid_api_key_12345
Content-Type: application/json

{
  "watcher_ver": "1.0.0"
}


### ============================================================
### 8. 기기 등록 (플레이어 자체 등록 - Public, JWT 불필요)
### - POST /players/register (PHP Dids.php > player_post 하위호환)
### - 기기가 직접 호출하는 엔드포인트 (API Key/JWT 불필요)
### ============================================================

### 8-1. 기기 등록 - 필수 필드만
POST {{baseUrl}}/players/register
Content-Type: application/json

{
  "player_ip": "192.168.10.50",
  "player_ver": "1.0.0"
}

### 8-2. 기기 등록 - 전체 필드
POST {{baseUrl}}/players/register
Content-Type: application/json

{
  "player_ip": "192.168.10.51",
  "player_ver": "2.0.0",
  "player_nick_name": "본관 1층 디스플레이",
  "building_seq": 1
}

### 8-3. 기기 등록 - 수동 등록 (MANUAL_REGISTER)
POST {{baseUrl}}/players/register
Content-Type: application/json

{
  "player_ip": "192.168.10.52",
  "player_ver": "MANUAL_REGISTER"
}

### 8-4. 기기 등록 - IP 중복 (FAIL 응답 예상)
POST {{baseUrl}}/players/register
Content-Type: application/json

{
  "player_ip": "192.168.10.50",
  "player_ver": "1.0.0"
}

# 예상: { "status": "FAIL", "message": "이미 사용 중인 IP 주소입니다." }

### 8-5. 기기 등록 - 필수 필드 누락 (400 에러)
POST {{baseUrl}}/players/register
Content-Type: application/json

{
  "player_ver": "1.0.0"
}

# 예상: 400 Bad Request (player_ip 누락)


### ============================================================
### 9. IP 재등록 프로세스 테스트 (순서대로 실행)
### - 생성 → 삭제 → 같은 IP 재등록 → 중복 시도
### ============================================================

### 9-1. 플레이어 생성
POST {{baseUrl}}/players
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "player_name": "재등록 테스트 플레이어",
  "player_ip": "192.168.99.100",
  "building_seq": 1,
  "player_resolution": "1920x1080"
}

# 응답에서 player_seq를 확인하여 아래 변수에 설정하세요
# @test_player_seq = <PLAYER_SEQ>

### 9-2. 플레이어 삭제
DELETE {{baseUrl}}/players/{{test_player_seq}}
Authorization: Bearer {{token}}

### 9-3. 같은 IP로 재등록 (재활성화)
POST {{baseUrl}}/players
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "player_name": "재등록된 플레이어",
  "player_ip": "192.168.99.100",
  "building_seq": 1,
  "player_resolution": "3840x2160",
  "player_description": "재활성화된 플레이어입니다"
}

# 응답 검증:
# - player_seq가 이전과 동일해야 함
# - message: "삭제된 플레이어가 재등록되었습니다."
# - player_api_key가 새로 생성됨

### 9-4. 활성 IP 중복 시도 (에러 확인)
POST {{baseUrl}}/players
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "player_name": "중복 시도",
  "player_ip": "192.168.1.100",
  "building_seq": 1
}

# 예상 결과: 409 Conflict
# 에러 메시지: "이미 사용 중인 IP 주소입니다."
